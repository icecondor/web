extends layout

block head
  script(src='//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js')
  script(src='//cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js')
  link(rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css")

block content

  div.page-map
    div.mapdecor
      div#status
        table
          thead#header
            tr
              td Username
              td Most recent
              td.widescreen Day
              td Points
          tr
            td
              a.userlink
                span.username
            td
              span#last_point
            td.widescreen
              select.month(disabled='1')
              select.day(disabled='1')
            td
              span#point_count

      div#map
      div.hidden#popup-holder

      div.fencelist.flexbox
        div.listhead Fences:
      template#fenceitem
        div.fenceitem(id="{{fence_id}}")
          a(href="/{{username}}/fences/{{fence_id}}") [fence]


  script.
    function locationBar(location) {
      var date = new XDate(location.date)
      var days = date.diffDays()
      var date_format
      if(days < 7) {
        date_format = "ddd h:mmtt"
      } else {
        date_format = "MMM-dd h:mmtt"
      }
      var point_last_html = '<time datetime='+JSON.stringify(location.date)+
                            ' data-format='+JSON.stringify(date_format)+
                            '/>'
      $('#last_point').html(point_last_html)
      time_fixups('#last_point')
    }

    function locationBarPointCount(count) {
      $('#point_count').html(count)
    }

    function setBarDate(date_str) {
      $('.page-map select').removeAttr('disabled')
      var date = new XDate(date_str)
      $('.page-map select.month').val(date.getMonth())
      $('.page-map select.day').val(date.getDate())
    }

    function day_selected(evt){
      var day = new XDate()
      day.setMonth($('.page-map select.month').val())
      day.setDate($('.page-map select.day').val())
      day.setHours(0)
      day.setMinutes(0)
      var stop = new XDate(day)
      stop.addDays(1)
      map.removeTracks()
      $('#last_point').html('')
      startFollow(params.username, day, stop, 1000, 'oldest')
    }

    function month_day_select_setup(){
      $('.page-map select').attr('disabled', true)
      for(var day=1; day <= 31; day++) {
        $('.page-map select.day').append('<option value=\''+day+'\'>'+day+'</option>')
      }
      [0,1,2,3,4,5,6,7,8,9,10,11].forEach(function(month_idx){
        var date = new XDate()
        date.setMonth(month_idx)
        $('.page-map select.month').append('<option value=\''+month_idx+'\' >'+date.toString('MMM')+'</option>')
      });
    }

    function startFollow(username, start, stop, count, order, follow){
      var filter = {username: username, type: "location", count: count, order: order}
      if(follow){filter.follow = follow}
      if(start) { filter.start = start.toISOString()}
      if(stop) { filter.stop = stop.toISOString()}
      if(params.key) {filter.key = params.key}
      var follow_tx = iceCondor.api('stream.follow', filter)
      iceCondor.onResponse(follow_tx, function(msg){
        statusTab()
        var track = map.addTrack(msg.stream_id, username)
        locationBarPointCount("-loading-")
        var firstPoint = true
        iceCondor.onResponse(msg.stream_id, function(location){
          var date_order_idx = map.addPointToTrack(msg.stream_id, location)
          if(date_order_idx == 0) {
            locationBar(location)
          }
          locationBarPointCount(track.points.length)
          if(firstPoint) {
            setBarDate(location.date)
            firstPoint = false
          }
        })
      }, function(err) {
        if(err.code == "UNF") {
          $('#map').html("<h2>User not found.</h2>")
        }
        if(err.code == "NOACCESS") {
          $('#map').html("<h2>Location data for "+username+" is private.</h2>")
          window.setTimeout(function(){
            window.location = "/"+username+"/profile"
          }, 2000)
        }
      })
    }

    var params = url_params(window.location.href)
    jQuery(function(){
      statusTab('Connecting')
      var paths = window.location.pathname.split('/')
      params.username = paths[1]

      var now = new XDate()
      var follow = true
      var day_count = 100
      var day_order = 'newest'
      var start, stop
      if(params.start) {
        start = new XDate(params.start)
        if(!params.stop){
          stop = new XDate(start)
          stop.addDays(1)
        }
        follow = false
        day_count = 1000
        day_order = 'oldest'
      }
      if(params.stop) {
        stop = new XDate(params.stop)
        follow = false
        day_count = 1000
        day_order = 'oldest'
      }

      month_day_select_setup()
      var center_of_america = [[32.8, -98.5],[48.8, -99.5]]
      map.setup(center_of_america)

      $('.mapdecor .username').html(params.username)
      $('.mapdecor .userlink').attr('href', "/"+params.username+"/profile")
      iceCondor.on('heartbeat', function(beat){
        var point_date_html = '<time datetime="'+beat.date+'" data-format="yyyy-MMM-d hh:mmtt"/>'
        $('#points').append('<li> heartbeat '+point_date_html+'</li>')
      })

      $('.page-map select').change(day_selected)

      // adjust map height after status bar has been populated
      var map_height = $(window).outerHeight()-
                          $('.navbar').outerHeight()-
                          $('#status').outerHeight()-
                          $('.footer').outerHeight()-5
      $("#map").height(map_height)
      map.resize()

      var action = getKey() ? 'auth' : 'hello'
      iceCondor.on(action, function(logged_in_user){
        startFollow(params.username, start, stop, day_count, day_order, follow)
        var userinfo_tx = iceCondor.api('user.detail')
        var layercache = {}
        iceCondor.onResponse(userinfo_tx, function(user){
          if(user.username == params.username) {
            if(user.latest){
              var item_tmpl = uStache.compile($('template#fenceitem').html())
              user.latest.fences.forEach(function(fence_id){
                $('.fencelist').append(item_tmpl({fence_id: fence_id, username: params.username}))
                var fence_tx = iceCondor.api('fence.get', {id: fence_id})
                iceCondor.onResponse(fence_tx, function(fence){
                  $('.fencelist .fenceitem#'+fence_id+' a').html(fence.name)
                  var latlngs = fence.geojson.coordinates[0].map(function(l){return [l[1],l[0]]})
                  var layer = L.polygon(latlngs)
                  layercache[fence_id] = layer
                  $('.fencelist .fenceitem#'+fence_id+' a').hover(function(evt){
                    map.map.map.addLayer(layercache[fence_id])
                  }, function(evt){
                    map.map.map.removeLayer(layercache[fence_id])
                  })
                })
              })
            }
          }
        })
      })
      iceCondor.connect()
    })
