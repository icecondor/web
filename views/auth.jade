extends layout

block content

  div.
    Auth

  div.askusername.hidden
    h2 Welcome to IceCondor
    p.
      Please enter a username.
    form
      input(type='text', name='username')
      input(type='submit', value='Save')

  script.
    var token = window.location.pathname.split('/')[2]
    var prefix = token.split('-')[0]
    if(prefix == "browser_key") {
      clearKey()
      setKey(token)
      iceCondor.connect()
      console.log('called auth')
      iceCondor.on("auth", function(session){
        if(session.user.username) {
          window.location = "/"
        } else {
          // missing username
          $('.askusername form').submit(function(event){
            console.log(event.target)
            var username = event.target.elements['username'].value
            var update_tx = iceCondor.api('user.update', {username: username})
            iceCondor.onResponse(update_tx, function(resp){
              console.log(resp)
              window.location = "/"
            })
            event.preventDefault()
          })
          $('.askusername').show()
        }
      })
    } else if(prefix == "device_key") {
      window.location = "icecondor://android/v2/auth?access_token="+token
    } else {
      // bad key
      console.log('bad key')
    }
